<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elderly Care App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='elderly-care-app.css') }}">
</head>
<body>
    <header>
        <nav>
            <ul class="nav-links">
                <li><a href="/">Home</a></li>
                <li><a href="#">Contact</a></li>
                <li><a href="#"><img src="login-icon.png" alt="Login" class="login-icon"></a></li>
            </ul>
        </nav>
        <h1>Elderly Care App</h1>
    </header>

    <main>
        <div id="voice-command-container">
            <button id="speak-btn" class="btn">Activate Voice Command</button>
        </div>

        <div id="main-content">
            <section id="pill-reminders" class="content-box">
                <h2>Pill Reminders</h2>
                <div id="reminder-box">
                    <div id="reminders-list">No reminders set.</div>
                </div>
            </section>

            <section id="virtual-assistant" class="content-box">
                <h2>Virtual Assistant</h2>
                <div id="assistant-output">How can I assist you today?</div>
            </section>

            <section id="community-network" class="content-box">
                <h2>Community Updates</h2>
                <div id="community-updates">No updates available</div>
            </section>
        </div>

        <div class='tableauPlaceholder' id='viz1724523921768' style='position: relative'>
            <noscript>
                <a href='#'>
                    <img alt='Dashboard 1 ' src='https://public.tableau.com/static/images/nl/nlp_aai_sample/Dashboard1/1_rss.png' style='border: none' />
                </a>
            </noscript>
            <object class='tableauViz' style='display:none;'>
                <param name='host_url' value='https%3A%2F%2Fpublic.tableau.com%2F' />
                <param name='embed_code_version' value='3' />
                <param name='site_root' value='' />
                <param name='name' value='nlp_aai_sample/Dashboard1' />
                <param name='tabs' value='no' />
                <param name='toolbar' value='yes' />
                <param name='static_image' value='https://public.tableau.com/static/images/nl/nlp_aai_sample/Dashboard1/1.png' />
                <param name='animate_transition' value='yes' />
                <param name='display_static_image' value='yes' />
                <param name='display_spinner' value='yes' />
                <param name='display_overlay' value='yes' />
                <param name='display_count' value='yes' />
                <param name='language' value='en-US' />
                <param name='filter' value='publish=yes' />
            </object>
            <script type='text/javascript'>
                var divElement = document.getElementById('viz1724523921768');
                var vizElement = divElement.getElementsByTagName('object')[0];
                if (divElement.offsetWidth > 800) {
                    vizElement.style.width = '1000px';
                    vizElement.style.height = '827px';
                } else if (divElement.offsetWidth > 500) {
                    vizElement.style.width = '1000px';
                    vizElement.style.height = '827px';
                } else {
                    vizElement.style.width = '100%';
                    vizElement.style.height = '1277px';
                }
                var scriptElement = document.createElement('script');
                scriptElement.src = 'https://public.tableau.com/javascripts/api/viz_v1.js';
                vizElement.parentNode.insertBefore(scriptElement, vizElement);
            </script>
        </div>
    </main>

    <footer>
        <p>&copy; 2024 Elderly Care App</p>
    </footer>

    <script src="{{ url_for('static', filename='elderly-care-app.js') }}"></script>
    <script src="{{ url_for('static', filename='pill-reminders.js') }}"></script>

    <script>
        // Voice command handling
        document.getElementById('speak-btn').addEventListener('click', () => {
            captureVoiceCommand();
        });

        function captureVoiceCommand() {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            
            recognition.lang = 'en-US'; // Set the language of the speech recognition
            recognition.interimResults = false; // Disable interim results
            
            recognition.onstart = function() {
                console.log("Voice recognition started. Try speaking into the microphone.");
            };

            recognition.onspeechend = function() {
                recognition.stop();
            };

            recognition.onresult = function(event) {
                const command = event.results[0][0].transcript;
                console.log("Voice command received: " + command);

                // Send the command to the backend
                sendVoiceCommandToBackend(command);
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
            };

            // Start speech recognition
            recognition.start();
        }

        function sendVoiceCommandToBackend(command) {
            fetch('/process_voice', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ command: command })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Handle the response from the backend
                console.log(data.message);
                document.getElementById('assistant-output').textContent = data.message;
                
                if (data.message.includes("Reminder set")) {
                    addPillToTimeline(command); // Custom function to add reminder visually
                }
            })
            .catch(error => console.error('Error sending voice command:', error));
        }

        function addPillToTimeline(command) {
            const pillInfo = command.replace('set reminder to take ', '').replace(' at', '').trim(); // Extract the pill info from command

            const reminderBox = document.getElementById('reminder-box');
            const reminderList = document.getElementById('reminders-list');

            reminderList.textContent = reminderList.textContent === 'No reminders set.' ? pillInfo : reminderList.textContent + ', ' + pillInfo;
        }
    </script>
</body>
</html>